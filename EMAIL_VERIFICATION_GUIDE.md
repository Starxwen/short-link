# 邮箱验证功能使用指南

## 功能概述

本次更新为星跃短链接系统添加了完整的邮箱验证功能和系统设置管理功能。

## 主要功能

### 1. 系统设置管理
- **基本设置**：网站名称、网站URL配置
- **邮件设置**：SMTP服务器配置、邮件发送测试
- **注册设置**：是否允许用户注册、是否需要邮箱验证

### 2. 邮箱验证功能
- 用户注册时可选择发送验证邮件
- 点击邮件中的验证链接激活账户
- 验证码24小时内有效

## 安装和配置步骤

### 第一步：更新数据库结构
运行以下脚本之一来更新数据库：

1. **如果系统是全新安装**：
   ```
   访问：http://你的域名/install/install.php
   ```

2. **如果系统已安装，需要添加邮箱验证功能**：
   ```
   访问：http://你的域名/create_settings_table.php
   访问：http://你的域名/update_email_verification.php
   ```

### 第二步：配置SMTP邮件设置
1. 登录管理面板（admin.php）
2. 点击"系统设置"标签
3. 在"邮件设置"部分配置以下信息：
   - SMTP服务器（如：smtp.gmail.com）
   - SMTP端口（如：587）
   - SMTP用户名（邮箱地址）
   - SMTP密码（邮箱密码或授权码）
   - 加密方式（TLS/SSL/无加密）
   - 发件人邮箱和名称

4. 点击"发送测试邮件"测试配置是否正确

### 第三步：配置注册设置
在"注册设置"部分可以：
- 开启/关闭用户注册功能
- 开启/关闭邮箱验证要求

## 常见邮箱服务商SMTP配置

### Gmail
- SMTP服务器：smtp.gmail.com
- 端口：587
- 加密：TLS
- 注意：需要开启"两步验证"并使用"应用专用密码"

### QQ邮箱
- SMTP服务器：smtp.qq.com
- 端口：587
- 加密：TLS
- 注意：需要开启SMTP服务并获取授权码

### 163邮箱
- SMTP服务器：smtp.163.com
- 端口：587
- 加密：TLS
- 注意：需要开启SMTP服务并设置授权码

### 企业微信邮箱
- SMTP服务器：smtp.exmail.qq.com
- 端口：587
- 加密：TLS

## 使用流程

### 用户注册流程
1. 用户访问注册页面
2. 填写用户名、密码、邮箱等信息
3. 如果开启了邮箱验证，系统会发送验证邮件
4. 用户查收邮件并点击验证链接
5. 验证成功后账户激活，可以正常登录

### 管理员操作流程
1. 登录管理面板
2. 进入"系统设置"标签
3. 配置各项设置并保存
4. 可以随时修改设置，立即生效

## 文件说明

### 新增文件
- `includes/Mailer.php` - 邮件发送类
- `ajax/settings.php` - 系统设置AJAX处理
- `verify_email.php` - 邮箱验证页面
- `create_settings_table.php` - 创建系统设置表
- `update_email_verification.php` - 添加邮箱验证字段

### 修改文件
- `admin.php` - 添加系统设置标签和功能
- `register.php` - 添加邮箱验证功能
- `ajax/update_user.php` - 修复字段验证问题

## 安全注意事项

1. **删除安装脚本**：安装完成后请删除以下文件：
   - `create_settings_table.php`
   - `update_email_verification.php`

2. **SMTP安全**：
   - 使用强密码作为SMTP密码
   - 建议使用应用专用密码而非主密码
   - 启用TLS或SSL加密

3. **权限控制**：
   - 只有管理员可以访问系统设置
   - 普通用户无法修改系统配置

## 故障排除

### 邮件发送失败
1. 检查SMTP配置是否正确
2. 确认邮箱服务商是否支持SMTP
3. 检查防火墙是否阻止SMTP端口
4. 确认用户名密码是否正确

### 验证链接无效
1. 检查验证码是否过期（24小时有效期）
2. 确认链接是否完整
3. 检查数据库中的验证记录

### 无法访问系统设置
1. 确认用户已登录
2. 确认用户具有管理员权限
3. 检查session是否正常

## 技术支持

如遇到问题，请检查：
1. PHP错误日志
2. 数据库连接状态
3. 文件权限设置
4. 服务器防火墙配置

---

**更新日期**：2025-12-15
**版本**：v2.0